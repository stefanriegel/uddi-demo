name: "Run UDDI + Cloudflare Demo"

on:
  workflow_dispatch:
    inputs:
      zone_fqdn:
        description: "Authoritative zone FQDN (must end with a dot)"
        default: "virtualife.pro."
        required: true
        type: string
      record_name:
        description: "Record name (label). Use empty for apex."
        default: "www"
        required: true
        type: string
      record_type:
        description: "DNS record type"
        required: true
        type: choice
        options: [A, AAAA, TXT, CNAME]
        default: A
      record_value:
        description: "A/AAAA=IP, CNAME=target FQDN (with dot), TXT=content"
        default: "203.0.113.10"
        required: true
        type: string
      ttl:
        description: "TTL seconds"
        default: 120
        required: true
        type: number
      orange_cloud:
        description: 'Orange Cloud'
        required: false
        type: boolean
        default: false
      action:
        description: "Terraform action"
        required: true
        type: choice
        options: [apply, destroy]
        default: apply

env:
  TF_IN_AUTOMATION: "true"

jobs:
  demo:
    name: "UDDI + Cloudflare Demo"
    runs-on: ubuntu-latest
    environment: dev
    defaults:
      run:
        working-directory: live/dev
    env:
      BLOXONE_HOST: ${{ vars.BLOXONE_HOST }}
      BLOXONE_API_KEY: ${{ secrets.BLOXONE_API_KEY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Cache Terraform state and plugins (local backend)
        uses: actions/cache@v4
        with:
          path: |
            live/dev/.terraform
            live/dev/.terraform.lock.hcl
            live/dev/terraform.tfstate
            live/dev/terraform.tfstate.backup
          key: tfstate-${{ github.workflow }}-${{ github.ref_name }}-${{ inputs.zone_fqdn }}-${{ inputs.record_name }}-${{ inputs.record_type }}

      - name: Terraform Init
        run: terraform init -input=false -no-color

      - name: Terraform Validate
        run: terraform validate -no-color

      - name: Terraform Plan
        id: plan
        run: |
          terraform plan -input=false -no-color \
            -var="bloxone_host=${BLOXONE_HOST:-https://csp.infoblox.com}" \
            -var="bloxone_api_key=${BLOXONE_API_KEY}" \
            -var="zone_fqdn=${{ inputs.zone_fqdn }}" \
            -var="record_name=${{ inputs.record_name }}" \
            -var="record_type=${{ inputs.record_type }}" \
            -var="record_value=${{ inputs.record_value }}" \
            -var="ttl=${{ inputs.ttl }}" \
            -var="orange_cloud=${{ inputs.orange_cloud }}" \
            -out=tfplan

      - name: Terraform Apply
        if: ${{ inputs.action == 'apply' }}
        run: |
          terraform apply -input=false -auto-approve -no-color tfplan
          terraform output -json > tfoutputs.json

      - name: Configure Cloudflare Orange Cloud
        if: ${{ inputs.action == 'apply' && inputs.orange_cloud == true && (inputs.record_type == 'A' || inputs.record_type == 'AAAA' || inputs.record_type == 'CNAME') }}
        run: |
          set -e
          echo "Enabling Cloudflare Orange Cloud for record..."
          
          # Extract record ID from Terraform output
          RECORD_ID=$(jq -r '.record_id.value' tfoutputs.json)
          echo "Record ID: ${RECORD_ID}"
          
          if [ "${RECORD_ID}" == "null" ] || [ -z "${RECORD_ID}" ]; then
            echo "ERROR: Could not extract record ID from Terraform output"
            exit 1
          fi
          
          # Get current record to preserve all fields
          CURRENT_RECORD=$(curl -s -H "Authorization: Token ${BLOXONE_API_KEY}" \
            "${BLOXONE_HOST}/api/ddi/v1/${RECORD_ID}")
          
          echo "Current record fetched"
          
          # Update provider_metadata with cloudflare_config
          UPDATED_RECORD=$(echo "${CURRENT_RECORD}" | jq '.result.provider_metadata = {"cloudflare_config": {"proxied": true}}')
          
          # Extract only the fields we need to update
          UPDATE_PAYLOAD=$(echo "${UPDATED_RECORD}" | jq '.result | {provider_metadata}')
          
          echo "Sending PATCH request to enable Cloudflare proxy..."
          
          # PATCH the record with updated provider_metadata
          RESPONSE=$(curl -s -X PATCH \
            -H "Authorization: Token ${BLOXONE_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "${UPDATE_PAYLOAD}" \
            "${BLOXONE_HOST}/api/ddi/v1/${RECORD_ID}")
          
          echo "Response: ${RESPONSE}"
          
          # Check if update was successful
          if echo "${RESPONSE}" | jq -e '.result.provider_metadata.cloudflare_config.proxied == true' > /dev/null; then
            echo "âœ… Cloudflare Orange Cloud enabled successfully"
          else
            echo "âš ï¸ Warning: Orange Cloud may not be enabled. Check response above."
          fi

      - name: Terraform Destroy
        if: ${{ inputs.action == 'destroy' }}
        run: |
          terraform destroy -input=false -auto-approve -no-color \
            -var="bloxone_host=${BLOXONE_HOST:-https://csp.infoblox.com}" \
            -var="bloxone_api_key=${BLOXONE_API_KEY}" \
            -var="zone_fqdn=${{ inputs.zone_fqdn }}" \
            -var="record_name=${{ inputs.record_name }}" \
            -var="record_type=${{ inputs.record_type }}" \
            -var="record_value=${{ inputs.record_value }}" \
            -var="ttl=${{ inputs.ttl }}" \
            -var="orange_cloud=${{ inputs.orange_cloud }}"

      - name: DNS Verification & Cloudflare Status
        if: ${{ inputs.action == 'apply' }}
        env:
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CF_ZONE_ID: ${{ secrets.CF_ZONE_ID }}
        run: |
          set -e
          
          # Wait for UDDI to Cloudflare sync
          echo "â³ Waiting 10 seconds for UDDI â†’ Cloudflare sync..."
          sleep 10
          echo ""
          
          # Construct FQDN
          if [ -z "${{ inputs.record_name }}" ]; then
            FQDN="${{ inputs.zone_fqdn }}"
          else
            FQDN="${{ inputs.record_name }}.${{ inputs.zone_fqdn }}"
          fi
          FQDN="${FQDN%.}."
          TYPE="${{ inputs.record_type }}"
          
          echo "============================================"
          echo "ðŸ” DNS VERIFICATION"
          echo "============================================"
          echo ""
          echo "Record: ${FQDN}"
          echo "Type: ${TYPE}"
          echo ""
          
          # Dig from multiple nameservers
          echo "ðŸ“¡ Querying Google DNS (8.8.8.8)..."
          dig +nocmd +noall +answer -t "${TYPE}" "${FQDN}" @8.8.8.8 | tee dig-google.txt || echo "(no answer)" | tee dig-google.txt
          if [ ! -s dig-google.txt ]; then
            echo "(no answer yet - DNS propagation in progress)" | tee dig-google.txt
          fi
          cat dig-google.txt
          echo ""
          
          echo "ðŸ“¡ Querying Cloudflare DNS (1.1.1.1)..."
          dig +nocmd +noall +answer -t "${TYPE}" "${FQDN}" @1.1.1.1 | tee dig-cloudflare.txt || echo "(no answer)" | tee dig-cloudflare.txt
          if [ ! -s dig-cloudflare.txt ]; then
            echo "(no answer yet - DNS propagation in progress)" | tee dig-cloudflare.txt
          fi
          cat dig-cloudflare.txt
          echo ""
          
          echo "ðŸ“¡ Querying Quad9 DNS (9.9.9.9)..."
          dig +nocmd +noall +answer -t "${TYPE}" "${FQDN}" @9.9.9.9 | tee dig-quad9.txt || echo "(no answer)" | tee dig-quad9.txt
          if [ ! -s dig-quad9.txt ]; then
            echo "(no answer yet - DNS propagation in progress)" | tee dig-quad9.txt
          fi
          cat dig-quad9.txt
          echo ""
          
          # Full dig for debugging
          echo "ðŸ”¬ Full DNS Query Details:"
          dig "${FQDN}" "${TYPE}" @8.8.8.8 | tee dig-full.txt
          echo ""
          
          # Query Cloudflare API if token is available
          if [ -n "${CF_API_TOKEN}" ]; then
            echo "============================================"
            echo "â˜ï¸  CLOUDFLARE DASHBOARD INFO"
            echo "============================================"
            echo ""
            
            # Auto-discover zone ID if not provided
            if [ -z "${CF_ZONE_ID}" ]; then
              echo "CF_ZONE_ID not set, looking up zone for ${{ inputs.zone_fqdn }}..."
              ZONE_NAME="${FQDN#*.}"  # Remove first label to get zone
              ZONE_NAME="${ZONE_NAME%.}"  # Remove trailing dot
              echo "Looking for zone: ${ZONE_NAME}"
              
              ZONE_LOOKUP=$(curl -s -X GET "https://api.cloudflare.com/v4/zones?name=${ZONE_NAME}" \
                -H "Authorization: Bearer ${CF_API_TOKEN}" \
                -H "Content-Type: application/json")
              
              CF_ZONE_ID=$(echo "${ZONE_LOOKUP}" | jq -r '.result[0].id // empty')
              
              if [ -n "${CF_ZONE_ID}" ]; then
                echo "Found Zone ID: ${CF_ZONE_ID}"
              else
                echo "âš ï¸  Could not find zone in Cloudflare account"
                echo "API Response: ${ZONE_LOOKUP}" | jq .
              fi
              echo ""
            fi
            
            if [ -n "${CF_ZONE_ID}" ]; then
              # Clean record name for API query
              RECORD_NAME="${FQDN%.}"
              
              echo "Querying Cloudflare API for: ${RECORD_NAME} (${TYPE})"
              echo "Zone ID: ${CF_ZONE_ID}"
              echo ""
              
              # Query Cloudflare API for record
              CF_RESPONSE=$(curl -s -X GET "https://api.cloudflare.com/v4/zones/${CF_ZONE_ID}/dns_records?name=${RECORD_NAME}&type=${TYPE}" \
                -H "Authorization: Bearer ${CF_API_TOKEN}" \
                -H "Content-Type: application/json")
              
              echo "${CF_RESPONSE}" > cf-response.json
              
              # Check API response success
              CF_SUCCESS=$(echo "${CF_RESPONSE}" | jq -r '.success' 2>/dev/null || echo "false")
              if [ "${CF_SUCCESS}" != "true" ]; then
                echo "âš ï¸  Cloudflare API Error:"
                echo "${CF_RESPONSE}" | jq -r '.errors[]?.message' 2>/dev/null || echo "Unknown error"
                echo ""
              fi
              
              # Check if record exists in Cloudflare
              RECORD_COUNT=$(echo "${CF_RESPONSE}" | jq -r '.result | length')
              
              if [ "${RECORD_COUNT}" -gt 0 ]; then
                echo "âœ… Record found in Cloudflare"
                echo ""
                
                # Extract record details
                CF_ID=$(echo "${CF_RESPONSE}" | jq -r '.result[0].id')
                CF_NAME=$(echo "${CF_RESPONSE}" | jq -r '.result[0].name')
                CF_TYPE=$(echo "${CF_RESPONSE}" | jq -r '.result[0].type')
                CF_CONTENT=$(echo "${CF_RESPONSE}" | jq -r '.result[0].content')
                CF_TTL=$(echo "${CF_RESPONSE}" | jq -r '.result[0].ttl')
                CF_PROXIED=$(echo "${CF_RESPONSE}" | jq -r '.result[0].proxied')
                CF_CREATED=$(echo "${CF_RESPONSE}" | jq -r '.result[0].created_on')
                CF_MODIFIED=$(echo "${CF_RESPONSE}" | jq -r '.result[0].modified_on')
                
                echo "ðŸ“‹ Record Details:"
                echo "   ID: ${CF_ID}"
                echo "   Name: ${CF_NAME}"
                echo "   Type: ${CF_TYPE}"
                echo "   Content: ${CF_CONTENT}"
                echo "   TTL: ${CF_TTL}"
                if [ "${CF_PROXIED}" == "true" ]; then
                  echo "   Proxy: ðŸŸ  ENABLED (Orange Cloud)"
                else
                  echo "   Proxy: âšª DISABLED (DNS Only)"
                fi
                echo "   Created: ${CF_CREATED}"
                echo "   Modified: ${CF_MODIFIED}"
                echo ""
                
                # Dashboard link
                echo "ðŸ”— Cloudflare Dashboard:"
                echo "   https://dash.cloudflare.com/${CF_ZONE_ID}/dns/records"
              else
                echo "âš ï¸  Record not yet synced to Cloudflare"
                echo "   (UDDI sync may take a few moments)"
              fi
            fi
          else
            echo "â„¹ï¸  Cloudflare API credentials not configured"
            echo "   Set CF_API_TOKEN and CF_ZONE_ID secrets to enable dashboard info"
          fi
          echo ""
          echo "============================================"

      - name: Upload artifacts (proof)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: demo-proof
          path: |
            live/dev/tfoutputs.json
            live/dev/dig-google.txt
            live/dev/dig-cloudflare.txt
            live/dev/dig-quad9.txt
            live/dev/dig-full.txt
            live/dev/cf-response.json
            live/dev/terraform.tfstate
          if-no-files-found: ignore
          retention-days: 7

      - name: Job Summary
        if: always()
        env:
          CF_ZONE_ID: ${{ secrets.CF_ZONE_ID }}
        run: |
          echo "# UDDI + Cloudflare Demo Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Configuration Section
          echo "## Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Action** | \`${{ inputs.action }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Zone** | \`${{ inputs.zone_fqdn }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Record Name** | \`${{ inputs.record_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Type** | \`${{ inputs.record_type }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Value** | \`${{ inputs.record_value }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **TTL** | \`${{ inputs.ttl }}\` |" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.orange_cloud }}" == "true" ]; then
            echo "| **Orange Cloud** | ENABLED |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| **Orange Cloud** | Disabled |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # DNS Verification Section
          if [ "${{ inputs.action }}" == "apply" ]; then
            echo "## DNS Verification" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [ -f "dig-google.txt" ]; then
              echo "### Google DNS (8.8.8.8)" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              cat dig-google.txt >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
            
            if [ -f "dig-cloudflare.txt" ]; then
              echo "### Cloudflare DNS (1.1.1.1)" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              cat dig-cloudflare.txt >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
            
            if [ -f "dig-quad9.txt" ]; then
              echo "### Quad9 DNS (9.9.9.9)" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              cat dig-quad9.txt >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
            
            # Cloudflare Dashboard Info
            if [ -f "cf-response.json" ]; then
              echo "## Cloudflare Dashboard" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              
              RECORD_COUNT=$(jq -r '.result | length' cf-response.json 2>/dev/null || echo "0")
              
              if [ "${RECORD_COUNT}" -gt 0 ]; then
                CF_NAME=$(jq -r '.result[0].name' cf-response.json)
                CF_TYPE=$(jq -r '.result[0].type' cf-response.json)
                CF_CONTENT=$(jq -r '.result[0].content' cf-response.json)
                CF_TTL=$(jq -r '.result[0].ttl' cf-response.json)
                CF_PROXIED=$(jq -r '.result[0].proxied' cf-response.json)
                CF_ID=$(jq -r '.result[0].id' cf-response.json)
                
                echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
                echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
                echo "| Status | Synced to Cloudflare |" >> $GITHUB_STEP_SUMMARY
                echo "| Record ID | \`${CF_ID}\` |" >> $GITHUB_STEP_SUMMARY
                echo "| Name | \`${CF_NAME}\` |" >> $GITHUB_STEP_SUMMARY
                echo "| Type | \`${CF_TYPE}\` |" >> $GITHUB_STEP_SUMMARY
                echo "| Content | \`${CF_CONTENT}\` |" >> $GITHUB_STEP_SUMMARY
                echo "| TTL | \`${CF_TTL}\` |" >> $GITHUB_STEP_SUMMARY
                
                if [ "${CF_PROXIED}" == "true" ]; then
                  echo "| Proxy Status | ENABLED (Orange Cloud) |" >> $GITHUB_STEP_SUMMARY
                else
                  echo "| Proxy Status | DISABLED (DNS Only) |" >> $GITHUB_STEP_SUMMARY
                fi
                
                echo "" >> $GITHUB_STEP_SUMMARY
                if [ -n "${CF_ZONE_ID}" ]; then
                  echo "[Open Cloudflare Dashboard](https://dash.cloudflare.com/${CF_ZONE_ID}/dns/records)" >> $GITHUB_STEP_SUMMARY
                fi
              else
                echo "Record not yet synced to Cloudflare (may take a few moments)" >> $GITHUB_STEP_SUMMARY
              fi
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          # Terraform Outputs
          if [ -f "tfoutputs.json" ]; then
            echo "## Terraform Outputs" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details>" >> $GITHUB_STEP_SUMMARY
            echo "<summary>View JSON</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
            cat tfoutputs.json >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Notes Section
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Notes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- State is kept local and cached via Actions Cache" >> $GITHUB_STEP_SUMMARY
          echo "- Use the same inputs for destroy to re-use cache" >> $GITHUB_STEP_SUMMARY
          echo "- CNAME targets must end with a trailing dot" >> $GITHUB_STEP_SUMMARY
          echo "- DNS propagation can take up to a few minutes" >> $GITHUB_STEP_SUMMARY
